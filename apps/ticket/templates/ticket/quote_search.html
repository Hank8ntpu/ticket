{% extends "core/base.html" %}

{% block title %}即點即算：機票報價搜尋{% endblock %}

{% block content %}
  <header class="mb-8">
    <h1 class="text-2xl font-bold text-blue-700">即點即算：機票報價搜尋</h1>
    <p class="mt-1 text-sm text-gray-600">
      想飛就飛！輸入出發地、艙等與日期，即刻掌握最低票價與下訂建議。
    </p>
  </header>

  <!-- 篩選表單（GET） -->
  <form id="searchForm" method="get" class="mb-5 grid gap-3 sm:grid-cols-2 lg:grid-cols-6">
    <!-- 關鍵字 -->
    <input
      type="text" name="q" value="{{ current.q }}"
      placeholder="關鍵字（航班/城市/機場）"
      class="input"
    />

    <!-- 出發機場(IATA) -->
    <select name="dep_airport" class="select">
      <option value="">出發機場(IATA)</option>
      {% for code in dep_airport_choices %}
        <option value="{{ code }}" {% if current.dep_airport == code %}selected{% endif %}>{{ code }}</option>
      {% endfor %}
    </select>

    <!-- 抵達機場(IATA) -->
    <select name="arr_airport" class="select">
      <option value="">抵達機場(IATA)</option>
      {% for code in arr_airport_choices %}
        <option value="{{ code }}" {% if current.arr_airport == code %}selected{% endif %}>{{ code }}</option>
      {% endfor %}
    </select>

    <!-- 出發城市 -->
    <select name="dep_city" class="select">
      <option value="">出發城市</option>
      {% for c in dep_city_choices %}
        <option value="{{ c }}" {% if current.dep_city == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>

    <!-- 抵達城市 -->
    <select name="arr_city" class="select">
      <option value="">抵達城市</option>
      {% for c in arr_city_choices %}
        <option value="{{ c }}" {% if current.arr_city == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>

    <!-- 航空公司 -->
    <select name="airline" class="select">
      <option value="">航空公司</option>
      {% for a in airline_choices %}
        <option value="{{ a }}" {% if current.airline == a %}selected{% endif %}>{{ a }}</option>
      {% endfor %}
    </select>

    <!-- 艙等 -->
    <select name="cabin" class="select">
      <option value="">艙等</option>
      {% for c in cabin_choices %}
        <option value="{{ c }}" {% if current.cabin == c %}selected{% endif %}>{{ c }}</option>
      {% endfor %}
    </select>

    <!-- 出發日期 -->
    <select name="dep_date" class="select">
      <option value="">出發日期</option>
      {% for d in date_choices %}
        {% with d_str=d|date:"Y-m-d" %}
          <option value="{{ d_str }}" {% if current.dep_date == d_str %}selected{% endif %}>{{ d_str }}</option>
        {% endwith %}
      {% endfor %}
    </select>

    <!-- 最低價 -->
    <input
      type="number" inputmode="numeric" name="min_price" value="{{ current.min_price }}"
      placeholder="最低價（{{ price_min_suggest }} 起）"
      class="input"
    />

    <!-- 最高價 -->
    <input
      type="number" inputmode="numeric" name="max_price" value="{{ current.max_price }}"
      placeholder="最高價（建議 ≤ {{ price_max_suggest }}）"
      class="input"
    />

    <!-- 排序 -->
    <select name="order_by" class="select">
      <option value="depDate"  {% if current.order_by == 'depDate' %}selected{% endif %}>出發日 ↑</option>
      <option value="-depDate" {% if current.order_by == '-depDate' %}selected{% endif %}>出發日 ↓</option>
      <option value="price"    {% if current.order_by == 'price' %}selected{% endif %}>價格 ↑</option>
      <option value="-price"   {% if current.order_by == '-price' %}selected{% endif %}>價格 ↓</option>
      <option value="recPrice" {% if current.order_by == 'recPrice' %}selected{% endif %}>建議價 ↑</option>
      <option value="-recPrice"{% if current.order_by == '-recPrice' %}selected{% endif %}>建議價 ↓</option>
    </select>

    <!-- 只顯示推薦 -->
    <label class="col-span-full inline-flex items-center gap-2 text-sm text-gray-700">
      <input
        type="checkbox" name="recommend_only" value="1"
        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
        {% if current.recommend_only %}checked{% endif %}
      />
      只顯示推薦（當前價 < 建議價）
    </label>

    <!-- 動作 -->
    <div class="col-span-full flex items-center gap-2">
      <button type="submit" class="btn btn-primary">搜尋</button>
      <a href="{% url 'ticket:quote_search' %}" class="btn btn-outline">清除條件</a>
      <span class="ml-auto text-sm text-gray-600">
        共 <span class="font-semibold text-gray-900">{{ total_count }}</span> 筆結果
      </span>
    </div>
  </form>

  <!-- 結果表格 -->
  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>出發日</th>
          <th>航班</th>
          <th>航點</th>
          <th>艙等</th>
          <th>價格</th>
          <th>建議價</th>
          <th>建議</th>
          <th>航空公司</th>
        </tr>
      </thead>
      <tbody>
        {% for p in page_obj %}
          <tr>
            <td>{{ p.depDate|date:"Y-m-d" }}</td>
            <td class="font-medium">{{ p.ticket.flightCode }}</td>
            <td>
              <span class="pill">{{ p.ticket.depAirportCode }}</span>
              →
              <span class="pill">{{ p.ticket.arrAirportCode }}</span>
              <div class="text-xs text-gray-500">{{ p.ticket.depCity }} → {{ p.ticket.arrCity }}</div>
            </td>
            <td>{{ p.Class }}</td>
            <td class="font-semibold text-emerald-700">{{ p.price }}</td>
            <td>{{ p.recPrice }}</td>
            <td>
              {% if p.price < p.recPrice %}
                <span class="badge badge-ok">推薦下訂</span>
              {% else %}
                <span class="badge badge-warn">觀望</span>
              {% endif %}
            </td>
            <td>{{ p.ticket.airline }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="8" class="text-center text-gray-500 py-6">沒有符合條件的資料</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 分頁 -->
  <nav class="mt-6 flex justify-center" aria-label="Pagination">
    <ul class="inline-flex items-center gap-1">
      {% if page_obj.has_previous %}
        <li>
          <a href="?{% for k,v in current.items %}{% if k != 'page' and v %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.previous_page_number }}" class="btn btn-outline">‹</a>
        </li>
      {% else %}
        <li><span class="btn btn-outline text-gray-400" aria-disabled="true">‹</span></li>
      {% endif %}

      {% for num in page_obj.paginator.page_range %}
        {% if num == page_obj.number %}
          <li><span class="btn btn-primary">{{ num }}</span></li>
        {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
          <li>
            <a href="?{% for k,v in current.items %}{% if k != 'page' and v %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ num }}" class="btn btn-outline">{{ num }}</a>
          </li>
        {% endif %}
      {% endfor %}

      {% if page_obj.has_next %}
        <li>
          <a href="?{% for k,v in current.items %}{% if k != 'page' and v %}{{ k }}={{ v|urlencode }}&{% endif %}{% endfor %}page={{ page_obj.next_page_number }}" class="btn btn-outline">›</a>
        </li>
      {% else %}
        <li><span class="btn btn-outline text-gray-400" aria-disabled="true">›</span></li>
      {% endif %}
    </ul>
  </nav>
{% endblock %}

{% block extra_scripts %}
<script>
  document.querySelectorAll('#searchForm select, #searchForm input[name=min_price], #searchForm input[name=max_price], #searchForm input[name=recommend_only]')
    .forEach(el => el.addEventListener('change', () => document.getElementById('searchForm').submit()));
</script>
{% endblock %}
